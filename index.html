<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Matrix Dev Escape - Precisão</title>

    <style>
      :root {
        --matrix-green: #00ff41;
        --bg: #000;
        --grid-color: rgba(0, 255, 65, 0.15);
        --modal-bg: rgba(0, 10, 0, 0.98);
        --game-width: 450px;
        --phase-color: var(--matrix-green);
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        color: var(--matrix-green);
        font-family: "Courier New", monospace;
        overflow: hidden;
        display: flex;
        justify-content: center;
      }

      #mobile-container {
        width: 100%;
        max-width: var(--game-width);
        height: 100vh;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        border-left: 1px solid #222;
        border-right: 1px solid #222;
        position: relative;
      }

      #top-info {
        padding: 10px;
        background: #000;
        border-bottom: 2px solid var(--phase-color);
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        font-weight: bold;
        z-index: 20;
      }

      #viewport {
        flex: 1;
        overflow: auto;
        scroll-snap-type: both mandatory;
        -webkit-overflow-scrolling: touch;
        border-bottom: 1px solid var(--phase-color);
        position: relative;
      }

      #world-mask {
        position: absolute;
        top: 0;
        left: 0;
        width: 1000%;
        height: 1000%;
        pointer-events: none;
        z-index: 10;
        background: radial-gradient(
          circle 120px at var(--vx) var(--vy),
          transparent 0%,
          rgba(0, 0, 0, 1) 100%
        );
        display: none;
      }

      #world {
        display: grid;
        grid-template-columns: repeat(10, var(--game-width));
        grid-template-rows: repeat(10, 70vh);
        width: calc(var(--game-width) * 10);
        height: 700vh;
      }

      .section {
        width: var(--game-width);
        height: 70vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        scroll-snap-align: start;
        padding: 20px;
        box-sizing: border-box;
        border: 1px solid rgba(0, 255, 65, 0.05);
      }

      .coord-label {
        opacity: 0.4;
        font-size: 1.2rem;
        font-weight: bold;
      }

      #footer {
        height: 160px;
        background: #000;
        display: flex;
        padding: 10px;
        gap: 10px;
        border-top: 2px solid var(--phase-color);
      }

      .mini-map-container {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .column-labels {
        display: flex;
        justify-content: space-around;
        font-size: 0.6rem;
        opacity: 0.6;
        color: var(--matrix-green);
        margin-bottom: 2px;
        margin-left: 15px;
      }

      .row-and-map {
        display: flex;
      }

      .row-labels {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        font-size: 0.6rem;
        opacity: 0.6;
        color: var(--matrix-green);
        padding-right: 5px;
      }

      #mini-map {
        flex: 1;
        height: 100%;
        border: 2px solid var(--phase-color);
        position: relative;
        overflow: hidden;
        background-image: linear-gradient(
            to right,
            var(--grid-color) 1px,
            transparent 1px
          ),
          linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 10% 10%;
        box-shadow: 0 0 10px var(--phase-color);
      }

      #map-light {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 5;
        pointer-events: none;
        display: none;
      }

      #player-dot {
        position: absolute;
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 8px #fff;
        z-index: 15;
        transform: translate(-50%, -50%);
      }

      .task-node {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--phase-color);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        opacity: 1;
      }

      .btn {
        background: transparent;
        border: 1px solid var(--phase-color);
        color: var(--phase-color);
        padding: 8px;
        cursor: pointer;
        font-family: "Courier New";
      }

      #modal-overlay {
        display: none;
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      #modal {
        background: var(--modal-bg);
        border: 1px solid var(--phase-color);
        padding: 20px;
        width: 85%;
        text-align: center;
      }

      #modal input {
        background: #000;
        border: 1px solid var(--phase-color);
        color: var(--phase-color);
        width: 90%;
        padding: 10px;
        margin: 10px 0;
        font-family: "Courier New";
      }

      .skill-tag {
        display: inline-block;
        padding: 2px 4px;
        border: 1px solid var(--phase-color);
        margin: 2px;
        font-size: 0.6rem;
      }

      .skill-missing {
        color: red;
      }

      .skill-collected {
        color: green;
      }

      #welcome-screen {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 200;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--matrix-green);
        font-family: "Courier New", monospace;
      }

      #welcome-content {
        text-align: center;
        max-width: 80%;
      }

      #welcome-content h1 {
        font-size: 2rem;
        margin-bottom: 20px;
      }

      #welcome-content p {
        font-size: 1.2rem;
        margin-bottom: 30px;
      }

      #phase-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
    </style>
  </head>

  <body>
    <div id="mobile-container">
      <div id="top-info">
        <span id="top-phase-name">FASE: ???</span>
        <span id="top-progress">Conhecimento: 0/0</span>
      </div>

      <div id="viewport">
        <div id="world-mask"></div>
        <div id="world"></div>
      </div>

      <div id="footer">
        <div class="mini-map-container">
          <div class="column-labels">
            <span>0</span><span>1</span><span>2</span><span>3</span
            ><span>4</span> <span>5</span><span>6</span><span>7</span
            ><span>8</span><span>9</span>
          </div>
          <div class="row-and-map">
            <div class="row-labels">
              <div>0</div>
              <div>1</div>
              <div>2</div>
              <div>3</div>
              <div>4</div>
              <div>5</div>
              <div>6</div>
              <div>7</div>
              <div>8</div>
              <div>9</div>
            </div>
            <div id="mini-map">
              <div id="map-light"></div>
              <div id="player-dot"></div>
            </div>
          </div>
        </div>
        <div style="flex: 1; font-size: 0.7rem; overflow-y: auto">
          <strong
            id="phase-label"
            style="
              display: block;
              color: var(--phase-color);
              margin-bottom: 4px;
            "
            >FASE</strong
          >
          <div id="skill-list">Nenhuma Habilidade</div>
        </div>
      </div>

      <div id="modal-overlay">
        <div id="modal">
          <h3 id="modal-title"></h3>
          <p id="modal-question"></p>
          <div id="modal-body"></div>
          <div id="modal-footer" style="margin-top: 15px">
            <button class="btn" onclick="closeModal()">FECHAR</button>
          </div>
        </div>
      </div>

      <div id="welcome-screen">
        <div id="welcome-content">
          <h1>Matrix Dev Escape</h1>
          <p>Escolha uma fase para começar:</p>
          <div id="phase-buttons"></div>
        </div>
      </div>
    </div>

    <script>
      const gameFases = [
        {
          id: 0,
          nome: "Criação de Projeto",
          escuro: false,
          color: "#00ff41",
          data: {
            "1,1": {
              q: "Qual comando cria um novo projeto Node.js?",
              a: "npm init",
              skill: "NODE_INIT",
            },
            "2,4": {
              q: "Qual tag HTML define a estrutura básica?",
              a: "html",
              skill: "HTML_BASIC",
            },
            "3,3": {
              q: "Qual atributo define o título da página?",
              a: "title",
              skill: "HTML_TITLE",
            },
            "6,2": {
              q: "Qual comando cria um arquivo vazio no Linux?",
              a: "touch",
              skill: "LINUX_TOUCH",
            },
            "1,2": {
              q: "Qual palavra declara uma variável em JS?",
              options: ["var", "let", "const"],
              a: 1,
              skill: "JS_VAR",
            },
            "5,5": { type: "EXIT" },
          },
        },

        {
          id: 1,
          nome: "Front-end Básico",
          escuro: true,
          color: "#00d4ff",
          data: {
            "1,2": {
              q: "Qual propriedade CSS define a cor de fundo?",
              a: "background-color",
              skill: "CSS_BACKGROUND",
            },
            "2,6": {
              q: "Qual seletor CSS seleciona todos os elementos?",
              a: "*",
              skill: "CSS_SELECTOR",
            },
            "4,4": {
              q: "Qual método JS adiciona um evento a um elemento?",
              a: "addeventlistener",
              skill: "JS_EVENT",
            },
            "6,1": {
              q: "Qual função JS converte string para número?",
              options: ["parseint", "tostring", "json.parse"],
              a: 0,
              skill: "JS_PARSEINT",
            },
            "9,9": { type: "EXIT" },
          },
        },

        {
          id: 2,
          nome: "Back-end com Node.js",
          escuro: true,
          color: "#f05032",
          data: {
            "1,8": {
              q: "Qual módulo Node.js cria um servidor HTTP?",
              a: "http",
              skill: "NODE_HTTP",
            },
            "3,2": {
              q: "Qual método Express define uma rota GET?",
              a: "get",
              skill: "EXPRESS_GET",
            },
            "5,5": {
              q: "Qual comando instala um pacote npm globalmente?",
              a: "npm install -g",
              skill: "NPM_GLOBAL",
            },
            "7,3": {
              q: "Qual objeto Node.js representa o sistema de arquivos?",
              options: ["fs", "path", "os"],
              a: 0,
              skill: "NODE_FS",
            },
            "9,9": { type: "EXIT" },
          },
        },

        {
          id: 3,
          nome: "Versionamento com Git",
          escuro: false,
          color: "#42b883",
          data: {
            "2,2": {
              q: "Qual comando inicializa um repositório Git?",
              a: "git init",
              skill: "GIT_INIT",
            },
            "3,4": {
              q: "Qual comando adiciona todos os arquivos ao stage?",
              a: "git add .",
              skill: "GIT_ADD_ALL",
            },
            "6,2": {
              q: "Qual comando cria um commit com mensagem?",
              a: "git commit -m",
              skill: "GIT_COMMIT_M",
            },
            "7,6": {
              q: "Qual comando envia commits para o repositório remoto?",
              options: ["git push", "git pull", "git fetch"],
              a: 0,
              skill: "GIT_PUSH",
            },
            "9,9": { type: "EXIT" },
          },
        },

        {
          id: 4,
          nome: "Containerização com Docker",
          escuro: true,
          color: "#61dafb",
          data: {
            "1,3": {
              q: "Qual comando constrói uma imagem Docker?",
              a: "docker build",
              skill: "DOCKER_BUILD",
            },
            "3,5": {
              q: "Qual comando executa um container Docker?",
              a: "docker run",
              skill: "DOCKER_RUN",
            },
            "5,2": {
              q: "Qual arquivo define as instruções de build no Docker?",
              a: "dockerfile",
              skill: "DOCKERFILE",
            },
            "7,7": {
              q: "Qual comando lista containers em execução?",
              options: ["docker ps", "docker images", "docker logs"],
              a: 0,
              skill: "DOCKER_PS",
            },
            "9,9": { type: "EXIT" },
          },
        },

        {
          id: 5,
          nome: "Deploy na Nuvem AWS",
          escuro: true,
          color: "#3178c6",
          data: {
            "2,1": {
              q: "Qual serviço AWS hospeda aplicações web?",
              a: "ec2",
              skill: "AWS_EC2",
            },
            "4,3": {
              q: "Qual serviço AWS armazena arquivos estáticos?",
              options: ["s3", "lambda", "rds"],
              a: 0,
              skill: "AWS_S3",
            },
            "5,6": {
              q: "Qual comando CLI da AWS lista buckets S3?",
              a: "aws s3 ls",
              skill: "AWS_CLI_S3",
            },
            "7,2": {
              q: "Qual serviço AWS executa código sem servidor?",
              options: ["lambda", "ec2", "s3"],
              a: 0,
              skill: "AWS_LAMBDA",
            },
            "9,9": { type: "EXIT" },
          },
        },
      ];

      let currentFaseIdx = 0;
      let inventory = [];
      let currentCoord = "";

      const world = document.getElementById("world");
      const viewport = document.getElementById("viewport");
      const minimap = document.getElementById("mini-map");
      const dot = document.getElementById("player-dot");
      const light = document.getElementById("map-light");
      const worldMask = document.getElementById("world-mask");
      const overlay = document.getElementById("modal-overlay");
      const welcomeScreen = document.getElementById("welcome-screen");

      function showWelcome() {
        const phaseButtons = document.getElementById("phase-buttons");
        phaseButtons.innerHTML = "";
        gameFases.forEach((fase, idx) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.innerText = `${fase.id + 1}. ${fase.nome}`;
          btn.onclick = () => startGame(idx);
          phaseButtons.appendChild(btn);
        });
        welcomeScreen.style.display = "flex";
      }

      function startGame(idx) {
        welcomeScreen.style.display = "none";
        loadPhase(idx);
      }

      function loadPhase(idx) {
        currentFaseIdx = idx;
        inventory = [];
        world.innerHTML = "";
        minimap.querySelectorAll(".task-node").forEach((n) => n.remove());

        const fase = gameFases[idx];

        document.documentElement.style.setProperty("--phase-color", fase.color);
        document.getElementById("phase-label").innerText = "FASE: " + fase.nome;
        document.getElementById("top-phase-name").innerText =
          "FASE: " + fase.nome;
        updateInventoryUI();

        worldMask.style.display = fase.escuro ? "block" : "none";
        light.style.display = fase.escuro ? "block" : "none";

        for (let r = 0; r < 10; r++) {
          for (let c = 0; c < 10; c++) {
            const coord = `${c},${r}`;
            const sec = document.createElement("section");
            sec.className = "section";

            if (fase.data[coord]) {
              const node = document.createElement("div");
              node.className = "task-node";
              node.id = `node-${coord}`;
              node.style.left = `${c * 10 + 5}%`;
              node.style.top = `${r * 10 + 5}%`;
              node.style.opacity = fase.escuro ? "0" : "1";
              if (fase.data[coord].type === "EXIT")
                node.style.background = "gold";
              minimap.appendChild(node);

              const isExit = fase.data[coord].type === "EXIT";
              sec.innerHTML = `<h2>[ ${
                isExit ? "Saída" : "Habilidade"
              } ${coord} ]</h2>
                <button class="btn" onclick="${
                  isExit ? "checkExit()" : `openTerminal('${coord}')`
                }">${isExit ? "DESBLOQUEAR" : "ACESSAR"}</button>`;
            } else {
              sec.innerHTML = `<span class="coord-label">${coord}</span>`;
            }
            world.appendChild(sec);
          }
        }
        viewport.scrollTo(0, 0);
      }

      function openTerminal(coord) {
        currentCoord = coord;
        const data = gameFases[currentFaseIdx].data[coord];
        document.getElementById("modal-title").innerText = "TERMINAL " + coord;
        document.getElementById("modal-question").innerText = data.q;
        const body = document.getElementById("modal-body");
        body.innerHTML = "";

        if (data.options) {
          data.options.forEach((opt, i) => {
            const b = document.createElement("button");
            b.className = "btn";
            b.style.width = "100%";
            b.innerText = opt;
            b.onclick = () => validate(i);
            body.appendChild(b);
          });
        } else {
          body.innerHTML = `<input type="text" id="ans" placeholder="Resposta..." autocomplete="off">
                           <button class="btn" style="width:100%" onclick="validate()">EXECUTAR</button>`;
          setTimeout(() => document.getElementById("ans").focus(), 150);
        }
        overlay.style.display = "flex";
      }

      function validate(choiceIdx = null) {
        const data = gameFases[currentFaseIdx].data[currentCoord];
        let isCorrect = false;

        if (choiceIdx !== null) isCorrect = choiceIdx === data.a;
        else
          isCorrect =
            document.getElementById("ans").value.toLowerCase().trim() ===
            data.a;

        if (isCorrect) {
          if (!inventory.includes(data.skill)) inventory.push(data.skill);
          document.getElementById(`node-${currentCoord}`).style.background =
            "#fff";
          updateInventoryUI();
          closeModal();
        } else {
          document.getElementById("modal-question").innerText =
            "ACESSO NEGADO - TENTE NOVAMENTE";
        }
      }

      function checkExit() {
        const faseData = gameFases[currentFaseIdx].data;
        const requiredSkills = new Set(
          Object.values(faseData)
            .filter((d) => d.skill)
            .map((d) => d.skill)
        );
        const collectedSkills = new Set(inventory);
        const allCollected = [...requiredSkills].every((skill) =>
          collectedSkills.has(skill)
        );

        document.getElementById("modal-title").innerText = allCollected
          ? "DESBLOQUEAR SAÍDA"
          : "SAÍDA BLOQUEADA";
        document.getElementById("modal-question").innerText =
          "Habilidades necessárias:";

        const body = document.getElementById("modal-body");
        body.innerHTML = "<ul>";
        requiredSkills.forEach((skill) => {
          const collected = collectedSkills.has(skill);
          body.innerHTML += `<li class="${
            collected ? "skill-collected" : "skill-missing"
          }">${skill}</li>`;
        });
        body.innerHTML += "</ul>";

        const footer = document.getElementById("modal-footer");
        footer.innerHTML = allCollected
          ? `<button class="btn" onclick="unlockExit()">DESBLOQUEAR</button>`
          : `<button class="btn" onclick="closeModal()">FECHAR</button>`;

        overlay.style.display = "flex";
      }

      function unlockExit() {
        closeModal();
        if (currentFaseIdx < gameFases.length - 1) {
          loadPhase(currentFaseIdx + 1);
        } else {
          document.getElementById("modal-title").innerText = "SISTEMA INVASO";
          document.getElementById("modal-question").innerText =
            "Você escapou da Matrix.";
          document.getElementById("modal-body").innerHTML = "";
          document.getElementById(
            "modal-footer"
          ).innerHTML = `<button class="btn" onclick="closeModal()">FECHAR</button>`;
          overlay.style.display = "flex";
        }
      }

      function updateInventoryUI() {
        const list = document.getElementById("skill-list");
        const topProg = document.getElementById("top-progress");
        const faseData = gameFases[currentFaseIdx].data;
        const required = Object.keys(faseData).filter(
          (k) => faseData[k].skill
        ).length;

        list.innerHTML = inventory.length
          ? inventory.map((s) => `<span class="skill-tag">${s}</span>`).join("")
          : "Nenhuma Habilidade";
        topProg.innerText = `NODOS: ${inventory.length}/${required}`;
      }

      function closeModal() {
        overlay.style.display = "none";
      }

      viewport.addEventListener("scroll", () => {
        const pctX =
          viewport.scrollLeft /
          (viewport.scrollWidth - viewport.clientWidth || 1);
        const pctY =
          viewport.scrollTop /
          (viewport.scrollHeight - viewport.clientHeight || 1);
        const mapW = minimap.clientWidth;
        const mapH = minimap.clientHeight;
        const posX = pctX * (mapW * 0.9) + mapW * 0.05;
        const posY = pctY * (mapH * 0.9) + mapH * 0.05;

        dot.style.left = posX + "px";
        dot.style.top = posY + "px";

        if (gameFases[currentFaseIdx].escuro) {
          light.style.background = `radial-gradient(circle 40px at ${posX}px ${posY}px, rgba(255,255,255,0.2) 0%, #000 100%)`;
          const vx = viewport.scrollLeft + viewport.clientWidth / 2;
          const vy = viewport.scrollTop + viewport.clientHeight / 2;
          worldMask.style.setProperty("--vx", vx + "px");
          worldMask.style.setProperty("--vy", vy + "px");

          minimap.querySelectorAll(".task-node").forEach((node) => {
            const nx = (parseFloat(node.style.left) * mapW) / 100;
            const ny = (parseFloat(node.style.top) * mapH) / 100;
            const d = Math.hypot(nx - posX, ny - posY);
            node.style.opacity = d < 40 ? "1" : "0";
          });
        } else {
          minimap
            .querySelectorAll(".task-node")
            .forEach((n) => (n.style.opacity = "1"));
        }
      });

      showWelcome();
    </script>
  </body>
</html>
