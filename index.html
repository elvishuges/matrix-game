<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Matrix Dev Escape - Precision</title>

    <style>
      :root {
        --matrix-green: #00ff41;
        --bg: #000;
        --grid-color: rgba(0, 255, 65, 0.15);
        --modal-bg: rgba(0, 10, 0, 0.98);
        /* AJUSTE: Agora usa 100% da largura da tela do celular */
        --game-width: 100vw;
        --phase-color: var(--matrix-green);
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        color: var(--matrix-green);
        font-family: "Courier New", monospace;
        overflow: hidden;
        display: flex;
        justify-content: center;
      }

      #mobile-container {
        width: 100%;
        max-width: 500px; /* Limite para desktop, mas 100% no mobile */
        height: 100vh;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        position: relative;
      }

      #top-info {
        padding: 10px;
        background: #000;
        border-bottom: 2px solid var(--phase-color);
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        font-weight: bold;
        z-index: 20;
      }

      #viewport {
        flex: 1;
        overflow: auto;
        scroll-snap-type: both mandatory;
        -webkit-overflow-scrolling: touch;
        border-bottom: 1px solid var(--phase-color);
        position: relative;
      }

      #world {
        display: grid;
        /* Cada coluna tem exatamente a largura da tela */
        grid-template-columns: repeat(10, var(--game-width));
        grid-template-rows: repeat(10, 70vh);
        width: calc(var(--game-width) * 10);
        height: 700vh;
      }

      .section {
        width: var(--game-width);
        height: 70vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        scroll-snap-align: start;
        scroll-snap-stop: always; /* Garante que pare em cada sala */
        padding: 20px;
        box-sizing: border-box;
        border: 1px solid rgba(0, 255, 65, 0.05);
      }

      #footer {
        height: 140px;
        background: #000;
        display: flex;
        padding: 10px;
        gap: 10px;
        border-top: 2px solid var(--phase-color);
      }

      #mini-map {
        flex: 1;
        height: 100%;
        border: 2px solid var(--phase-color);
        position: relative;
        overflow: hidden;
        background-image: linear-gradient(
            to right,
            var(--grid-color) 1px,
            transparent 1px
          ),
          linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 10% 10%;
      }

      #player-dot {
        position: absolute;
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 8px #fff;
        z-index: 15;
        transform: translate(-50%, -50%);
        transition: left 0.1s, top 0.1s;
      }

      .task-node {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--phase-color);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
      }

      .btn {
        background: transparent;
        border: 1px solid var(--phase-color);
        color: var(--phase-color);
        padding: 10px;
        cursor: pointer;
        font-family: "Courier New";
        font-weight: bold;
      }

      #modal-overlay {
        display: none;
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      #modal {
        background: var(--modal-bg);
        border: 1px solid var(--phase-color);
        padding: 20px;
        width: 85%;
        text-align: center;
      }

      #modal input {
        background: #000;
        border: 1px solid var(--phase-color);
        color: #fff;
        width: 90%;
        padding: 12px;
        margin: 10px 0;
        font-family: "Courier New";
      }

      .skill-tag {
        display: inline-block;
        padding: 2px 4px;
        border: 1px solid var(--phase-color);
        margin: 2px;
        font-size: 0.55rem;
        white-space: nowrap;
      }

      #world-mask {
        position: absolute;
        top: 0;
        left: 0;
        width: 1000%;
        height: 1000%;
        pointer-events: none;
        z-index: 10;
        background: radial-gradient(
          circle 100px at var(--vx) var(--vy),
          transparent 0%,
          rgba(0, 0, 0, 1) 100%
        );
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="mobile-container">
      <div id="top-info">
        <span id="top-phase-name">LOADING...</span>
        <span id="top-progress">NODES: 0/0</span>
      </div>

      <div id="viewport">
        <div id="world-mask"></div>
        <div id="world"></div>
      </div>

      <div id="footer">
        <div id="mini-map">
          <div id="player-dot"></div>
        </div>
        <div style="flex: 1; font-size: 0.65rem; overflow-y: auto">
          <strong
            id="phase-label"
            style="
              display: block;
              color: var(--phase-color);
              margin-bottom: 4px;
            "
            >PHASE</strong
          >
          <div id="skill-list">Nenhuma</div>
        </div>
      </div>

      <div id="modal-overlay">
        <div id="modal">
          <h3 id="modal-title"></h3>
          <p id="modal-question"></p>
          <div id="modal-body"></div>
          <button
            class="btn"
            style="margin-top: 15px; width: 100%"
            onclick="closeModal()"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <script>
      // Mantive seu array gameFases original aqui para não perder as 10+ questões
      const gameFases = [
        {
          id: 0,
          nome: "ESTRUTURA",
          escuro: false,
          color: "#00ff41",
          data: {
            "1,1": {
              q: "Qual tag define o corpo do HTML?",
              a: "body",
              skill: "HTML_BODY",
            },
            "2,4": {
              q: "Qual atributo define o caminho de um script JS?",
              a: "src",
              skill: "HTML_SCRIPT_SRC",
            },
            "3,3": {
              q: "Comando Linux para listar arquivos?",
              a: "ls",
              skill: "LINUX_LS",
            },
            "6,2": {
              q: "Comando Linux para criar diretório?",
              a: "mkdir",
              skill: "LINUX_MKDIR",
            },
            "1,2": {
              q: "Qual palavra cria uma constante no JavaScript?",
              options: ["var", "let", "const"],
              a: 2,
              skill: "JS_CONST",
            },
            "5,5": { type: "EXIT" },
          },
        },
        {
          id: 1,
          nome: "DOCKER & JS",
          escuro: true,
          color: "#00d4ff",
          data: {
            "1,2": {
              q: "Qual palavra cria uma constante no JavaScript?",
              options: ["var", "let", "const"],
              a: 2,
              skill: "JS_CONST",
            },
            "2,6": {
              q: "Qual método converte JSON em objeto JavaScript?",
              a: "json.parse",
              skill: "JS_JSON_PARSE",
            },
            "4,4": {
              q: "Docker: comando para listar containers em execução?",
              a: "docker ps",
              skill: "DOCKER_PS",
            },
            "6,1": {
              q: "Arquivo de build no Docker?",
              options: ["docker.json", "dockerfile", "docker-compose.yml"],
              a: 1,
              skill: "DOCKERFILE",
            },
            "9,9": { type: "EXIT" },
          },
        },
        {
          id: 2,
          nome: "GIT CONTROL",
          escuro: true,
          color: "#f05032",
          data: {
            "1,8": {
              q: "Comando Git para clonar um repositório?",
              a: "git clone",
              skill: "GIT_CLONE",
            },
            "3,2": {
              q: "Qual comando cria um commit?",
              options: ["git push", "git commit", "git add"],
              a: 1,
              skill: "GIT_COMMIT",
            },
            "5,5": {
              q: "Qual comando adiciona arquivos ao stage?",
              options: ["git add", "git status", "git log"],
              a: 0,
              skill: "GIT_ADD",
            },
            "7,3": {
              q: "Qual comando troca de branch?",
              options: ["git checkout", "git branch", "git merge"],
              a: 0,
              skill: "GIT_CHECKOUT",
            },
            "9,9": { type: "EXIT" },
          },
        },
        // ... (Adicione as outras fases aqui conforme o seu código anterior)
      ];

      let currentFaseIdx = 0;
      let inventory = [];
      let currentCoord = "";

      const world = document.getElementById("world");
      const viewport = document.getElementById("viewport");
      const minimap = document.getElementById("mini-map");
      const dot = document.getElementById("player-dot");
      const worldMask = document.getElementById("world-mask");
      const overlay = document.getElementById("modal-overlay");

      function loadPhase(idx) {
        currentFaseIdx = idx;
        inventory = [];
        world.innerHTML = "";
        minimap.querySelectorAll(".task-node").forEach((n) => n.remove());

        const fase = gameFases[idx];
        document.documentElement.style.setProperty("--phase-color", fase.color);
        document.getElementById("top-phase-name").innerText =
          "PHASE: " + fase.nome;
        document.getElementById("phase-label").innerText =
          "PHASE: " + fase.nome;

        worldMask.style.display = fase.escuro ? "block" : "none";

        for (let r = 0; r < 10; r++) {
          for (let c = 0; c < 10; c++) {
            const coord = `${c},${r}`;
            const sec = document.createElement("section");
            sec.className = "section";
            if (fase.data[coord]) {
              const node = document.createElement("div");
              node.className = "task-node";
              node.id = `node-${coord}`;
              node.style.left = `${c * 10 + 5}%`;
              node.style.top = `${r * 10 + 5}%`;
              if (fase.data[coord].type === "EXIT")
                node.style.background = "gold";
              minimap.appendChild(node);
              const isExit = fase.data[coord].type === "EXIT";
              sec.innerHTML = `<h2>[ ${isExit ? "EXIT" : "NODE"} ${coord} ]</h2>
                <button class="btn" onclick="${
                  isExit ? "checkExit()" : `openTerminal('${coord}')`
                }">${isExit ? "UNSEAL" : "ACCESS"}</button>`;
            } else {
              sec.innerHTML = `<span style="opacity:0.2">${coord}</span>`;
            }
            world.appendChild(sec);
          }
        }
        updateInventoryUI();
        viewport.scrollTo(0, 0);
      }

      function openTerminal(coord) {
        currentCoord = coord;
        const data = gameFases[currentFaseIdx].data[coord];
        document.getElementById("modal-title").innerText = "TERMINAL " + coord;
        document.getElementById("modal-question").innerText = data.q;
        const body = document.getElementById("modal-body");
        body.innerHTML = "";
        if (data.options) {
          data.options.forEach((opt, i) => {
            const b = document.createElement("button");
            b.className = "btn";
            b.style.width = "100%";
            b.style.marginBottom = "8px";
            b.innerText = opt;
            b.onclick = () => validate(i);
            body.appendChild(b);
          });
        } else {
          body.innerHTML = `<input type="text" id="ans" placeholder="Sua resposta...">
                           <button class="btn" style="width:100%" onclick="validate()">EXECUTE</button>`;
          setTimeout(() => document.getElementById("ans").focus(), 150);
        }
        overlay.style.display = "flex";
      }

      function validate(choiceIdx = null) {
        const data = gameFases[currentFaseIdx].data[currentCoord];
        const isCorrect =
          choiceIdx !== null
            ? choiceIdx === data.a
            : document.getElementById("ans").value.toLowerCase().trim() ===
              data.a;
        if (isCorrect) {
          if (!inventory.includes(data.skill)) inventory.push(data.skill);
          document.getElementById(`node-${currentCoord}`).style.background =
            "#fff";
          updateInventoryUI();
          closeModal();
        } else {
          alert("Acesso Negado!");
        }
      }

      function checkExit() {
        const faseData = gameFases[currentFaseIdx].data;
        const req = Object.keys(faseData).filter(
          (k) => faseData[k].skill
        ).length;
        if (inventory.length >= req) {
          if (currentFaseIdx < gameFases.length - 1)
            loadPhase(currentFaseIdx + 1);
          else alert("CONGRATULATIONS! MATRIX ESCAPED.");
        } else
          alert(`Bloqueado! Extraia mais ${req - inventory.length} dados.`);
      }

      function updateInventoryUI() {
        const faseData = gameFases[currentFaseIdx].data;
        const req = Object.keys(faseData).filter(
          (k) => faseData[k].skill
        ).length;
        document.getElementById("skill-list").innerHTML = inventory
          .map((s) => `<span class="skill-tag">${s}</span>`)
          .join("");
        document.getElementById(
          "top-progress"
        ).innerText = `NODES: ${inventory.length}/${req}`;
      }

      function closeModal() {
        overlay.style.display = "none";
      }

      viewport.addEventListener("scroll", () => {
        const pctX =
          viewport.scrollLeft /
          (viewport.scrollWidth - viewport.clientWidth || 1);
        const pctY =
          viewport.scrollTop /
          (viewport.scrollHeight - viewport.clientHeight || 1);
        const mapW = minimap.clientWidth;
        const mapH = minimap.clientHeight;
        const posX = pctX * (mapW * 0.9) + mapW * 0.05;
        const posY = pctY * (mapH * 0.9) + mapH * 0.05;
        dot.style.left = posX + "px";
        dot.style.top = posY + "px";

        if (gameFases[currentFaseIdx].escuro) {
          const vx = viewport.scrollLeft + viewport.clientWidth / 2;
          const vy = viewport.scrollTop + viewport.clientHeight / 2;
          worldMask.style.setProperty("--vx", vx + "px");
          worldMask.style.setProperty("--vy", vy + "px");
        }
      });

      loadPhase(0);
    </script>
  </body>
</html>
